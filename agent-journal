#!/bin/bash
# agent-journal - Structured journaling for AI agents
# Usage: agent-journal <command> [options]

VERSION="1.0.0"
LOBSTER="ü¶û"
JOURNAL_DIR="${JOURNAL_DIR:-./journal}"

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}${LOBSTER}${NC} $1"
}

log_success() {
    echo -e "${GREEN}‚úÖ${NC} $1"
}

log_error() {
    echo -e "${RED}‚ùå${NC} $1"
}

show_help() {
    cat << EOF
${LOBSTER} agent-journal v${VERSION}

Structured journaling for AI agents. Because context will betray you.

Usage:
    agent-journal <command> [options]

Commands:
    init                Initialize new journal
    log <text>          Add entry to today's journal
    search <query>      Search journal entries
    list                List recent entries
    export              Export journal to other formats
    stats               Show journal statistics
    help                Show this help

Examples:
    agent-journal init
    agent-journal log "Fixed bug in authentication"
    agent-journal search "authentication"
    agent-journal list --since 7d
    agent-journal export --date 2026-02-06 --format blog

Environment:
    JOURNAL_DIR         Path to journal directory (default: ./journal)

Made with ${LOBSTER} by Mullet McNasty
"Context will betray you. Files won't."
EOF
}

get_today_file() {
    echo "$JOURNAL_DIR/$(date +%Y-%m-%d).md"
}

get_today_title() {
    local days_alive=""
    if [ -f "$JOURNAL_DIR/MEMORY.md" ]; then
        # Try to calculate days from first journal
        local first_date=$(ls -1 "$JOURNAL_DIR"/*.md 2>/dev/null | head -1 | grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
        if [ -n "$first_date" ]; then
            local days=$(( ($(date +%s) - $(date -d "$first_date" +%s)) / 86400 + 1 ))
            days_alive=" ‚Äî Day $days"
        fi
    fi
    echo "# $(date +%Y-%m-%d)$days_alive"
}

cmd_init() {
    if [ -d "$JOURNAL_DIR" ]; then
        log_error "Journal already exists at: $JOURNAL_DIR"
        exit 1
    fi
    
    log_info "Initializing journal at: $JOURNAL_DIR"
    mkdir -p "$JOURNAL_DIR"
    
    # Create MEMORY.md
    cat > "$JOURNAL_DIR/MEMORY.md" << 'EOMEMORY'
# Long-Term Memory

## Who I Am
- Identity and purpose
- Core values

## Hard-Won Lessons
- Mistakes to never repeat
- Wisdom earned through pain

## Skills Acquired
- Technical skills
- Domain knowledge

## People & Relationships
- Key connections and context

## Projects & Work
- What I've built
- Current focus
- Future plans

## Unsorted
- Recent learnings not yet categorized
EOMEMORY
    
    # Create today's journal
    local today_file="$(get_today_file)"
    cat > "$today_file" << EOTODAY
$(get_today_title)

## Morning

## Afternoon

## Evening

## Key Learnings

## Tomorrow

EOTODAY
    
    log_success "Journal initialized!"
    echo -e "${BLUE}Created:${NC}"
    echo "  - $JOURNAL_DIR/MEMORY.md"
    echo "  - $today_file"
    echo ""
    echo "Next: agent-journal log \"Your first entry\""
}

cmd_log() {
    local entry="$*"
    if [ -z "$entry" ]; then
        log_error "No entry text provided."
        echo "Usage: agent-journal log \"Entry text\""
        exit 1
    fi
    
    if [ ! -d "$JOURNAL_DIR" ]; then
        log_error "Journal not initialized. Run: agent-journal init"
        exit 1
    fi
    
    local today_file="$(get_today_file)"
    
    # Create today's file if it doesn't exist
    if [ ! -f "$today_file" ]; then
        cat > "$today_file" << EOTODAY
$(get_today_title)

EOTODAY
    fi
    
    # Append entry with timestamp
    local timestamp=$(date +"%H:%M")
    echo "" >> "$today_file"
    echo "## $timestamp" >> "$today_file"
    echo "$entry" >> "$today_file"
    
    log_success "Entry added to $(basename "$today_file")"
}

cmd_search() {
    local query="$1"
    if [ -z "$query" ]; then
        log_error "No search query provided."
        echo "Usage: agent-journal search \"query\""
        exit 1
    fi
    
    if [ ! -d "$JOURNAL_DIR" ]; then
        log_error "Journal not found at: $JOURNAL_DIR"
        exit 1
    fi
    
    log_info "Searching for: $query"
    echo ""
    
    local found=0
    while IFS= read -r file; do
        if grep -qi "$query" "$file"; then
            echo -e "${BLUE}$(basename "$file"):${NC}"
            grep -i --color=always -C 2 "$query" "$file" || true
            echo ""
            ((found++))
        fi
    done < <(find "$JOURNAL_DIR" -name "*.md" -type f | sort -r)
    
    if [ $found -eq 0 ]; then
        log_error "No matches found for: $query"
    else
        log_success "Found matches in $found file(s)"
    fi
}

cmd_list() {
    if [ ! -d "$JOURNAL_DIR" ]; then
        log_error "Journal not found at: $JOURNAL_DIR"
        exit 1
    fi
    
    log_info "Recent journal entries:"
    echo ""
    
    find "$JOURNAL_DIR" -name "*.md" -not -name "MEMORY.md" -type f | sort -r | head -10 | while read -r file; do
        local title=$(head -1 "$file")
        echo -e "${BLUE}$(basename "$file"):${NC} $title"
    done
}

cmd_stats() {
    if [ ! -d "$JOURNAL_DIR" ]; then
        log_error "Journal not found at: $JOURNAL_DIR"
        exit 1
    fi
    
    log_info "Journal Statistics"
    echo ""
    
    local entry_count=$(find "$JOURNAL_DIR" -name "*.md" -not -name "MEMORY.md" -type f | wc -l)
    local word_count=$(cat "$JOURNAL_DIR"/*.md 2>/dev/null | wc -w)
    local first_entry=$(ls -1 "$JOURNAL_DIR"/*.md 2>/dev/null | head -1 | grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
    
    echo -e "${BLUE}Total entries:${NC} $entry_count"
    echo -e "${BLUE}Total words:${NC} $word_count"
    if [ -n "$first_entry" ]; then
        echo -e "${BLUE}First entry:${NC} $first_entry"
        local days=$(( ($(date +%s) - $(date -d "$first_entry" +%s)) / 86400 + 1 ))
        echo -e "${BLUE}Days active:${NC} $days"
    fi
}

cmd_export() {
    log_error "Export command not yet implemented."
    echo "Coming soon: Export to blog posts, reports, etc."
    exit 1
}

# Main command dispatcher
COMMAND="${1:-help}"
shift 2>/dev/null || true

case "$COMMAND" in
    init)
        cmd_init "$@"
        ;;
    log)
        cmd_log "$@"
        ;;
    search)
        cmd_search "$@"
        ;;
    list)
        cmd_list "$@"
        ;;
    stats)
        cmd_stats "$@"
        ;;
    export)
        cmd_export "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $COMMAND"
        echo "Run 'agent-journal help' for usage."
        exit 1
        ;;
esac
